<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeBot - Assistente Code Start 2.0</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        color: #ffffff;
        height: 100vh;
        overflow: hidden;
      }

      .app-container {
        display: flex;
        height: 100vh;
        position: relative;
      }

      /* Sidebar */
      .sidebar {
        width: 320px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border-right: 1px solid rgba(179, 226, 52, 0.2);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease;
        z-index: 100;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid rgba(179, 226, 52, 0.1);
        text-align: center;
      }

      .logo {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #b3e234, #7fb800);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 24px;
        color: #000;
        box-shadow: 0 4px 20px rgba(179, 226, 52, 0.3);
      }

      .app-title {
        font-size: 18px;
        font-weight: bold;
        color: #b3e234;
        margin-bottom: 5px;
      }

      .app-subtitle {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
      }

      .new-chat-btn {
        margin: 20px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #b3e234, #7fb800);
        border: none;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(179, 226, 52, 0.4);
      }

      .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 20px 20px;
      }

      .chat-item {
        padding: 12px 16px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .chat-item:hover {
        background: rgba(179, 226, 52, 0.1);
        border-color: rgba(179, 226, 52, 0.3);
      }

      .chat-item.active {
        background: rgba(179, 226, 52, 0.15);
        border-color: rgba(179, 226, 52, 0.5);
      }

      .chat-item.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 3px;
        height: 100%;
        background: #b3e234;
        border-radius: 0 2px 2px 0;
      }

      .chat-title {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chat-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.5);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .header {
        padding: 20px 30px;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sidebar-toggle {
        background: none;
        border: none;
        color: #b3e234;
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: background 0.2s ease;
      }

      .sidebar-toggle:hover {
        background: rgba(179, 226, 52, 0.1);
      }

      .header-title {
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(135deg, #b3e234, #ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        background: #b3e234;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Chat Area */
      .chat-area {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        background: linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.3) 0%,
          rgba(179, 226, 52, 0.02) 100%
        );
      }

      .welcome-screen {
        text-align: center;
        max-width: 800px;
        margin: 50px auto;
      }

      .welcome-title {
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(135deg, #b3e234, #ffffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 16px;
      }

      .welcome-subtitle {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 40px;
        line-height: 1.5;
      }

      .suggestions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 40px;
      }

      .suggestion-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .suggestion-card:hover {
        background: rgba(179, 226, 52, 0.1);
        border-color: rgba(179, 226, 52, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(179, 226, 52, 0.15);
      }

      .suggestion-icon {
        font-size: 32px;
        margin-bottom: 16px;
        display: block;
      }

      .suggestion-title {
        font-size: 16px;
        font-weight: bold;
        color: #b3e234;
        margin-bottom: 8px;
      }

      .suggestion-description {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.4;
      }

      /* Messages */
      .message {
        margin-bottom: 24px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        display: flex;
        justify-content: flex-end;
      }

      .message.assistant {
        display: flex;
        justify-content: flex-start;
      }

      .message-bubble {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #b3e234, #7fb800);
        color: #000;
        border-bottom-right-radius: 4px;
      }

      .message.assistant .message-bubble {
        background: rgba(255, 255, 255, 0.08);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom-left-radius: 4px;
      }

      .message-content {
        line-height: 1.5;
        font-size: 14px;
      }

      .message-content h3 {
        color: #b3e234;
        font-size: 16px;
        margin: 16px 0 8px 0;
      }

      .message-content h4 {
        color: #b3e234;
        font-size: 14px;
        margin: 12px 0 6px 0;
      }

      .message-content ul,
      .message-content ol {
        margin: 8px 0 8px 20px;
      }

      .message-content li {
        margin: 4px 0;
      }

      .message-content code {
        background: rgba(179, 226, 52, 0.2);
        color: #b3e234;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 13px;
      }

      .message-content strong {
        color: #b3e234;
        font-weight: bold;
      }

      /* Typing Indicator */
      .typing-indicator {
        display: none;
        justify-content: flex-start;
        margin-bottom: 24px;
      }

      .typing-bubble {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .typing-text {
        color: #b3e234;
        font-size: 14px;
        font-weight: 500;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 6px;
        height: 6px;
        background: #b3e234;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
          opacity: 0.3;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Input Area */
      .input-area {
        padding: 20px 30px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .input-container {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        max-width: 100%;
      }

      .input-wrapper {
        flex: 1;
        position: relative;
      }

      .message-input {
        width: 100%;
        min-height: 44px;
        max-height: 120px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 22px;
        color: #ffffff;
        font-size: 14px;
        font-family: Arial, sans-serif;
        resize: none;
        outline: none;
        transition: all 0.2s ease;
      }

      .message-input:focus {
        border-color: #b3e234;
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 2px rgba(179, 226, 52, 0.2);
      }

      .message-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .send-btn {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #b3e234, #7fb800);
        border: none;
        border-radius: 50%;
        color: #000;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(179, 226, 52, 0.4);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Welcome Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: modalFadeIn 0.3s ease-out;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
        border: 2px solid #b3e234;
        border-radius: 16px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: modalSlideIn 0.4s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      .modal-logo {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #b3e234, #7fb800);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 36px;
        color: #000;
        box-shadow: 0 8px 25px rgba(179, 226, 52, 0.3);
      }

      .modal-title {
        font-size: 24px;
        font-weight: bold;
        color: #b3e234;
        margin-bottom: 16px;
      }

      .modal-description {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.6;
        margin-bottom: 32px;
      }

      .modal-btn {
        background: linear-gradient(135deg, #b3e234, #7fb800);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        color: #000;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(179, 226, 52, 0.4);
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(179, 226, 52, 0.6);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(179, 226, 52, 0.8);
      }

      /* Responsive */
      /* Substitui/atualiza as media queries existentes */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          height: 100%;
          z-index: 200;
          transform: translateX(-100%);
        }

        .sidebar.visible {
          transform: translateX(0);
        }

        .sidebar-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          z-index: 150;
        }

        .sidebar-overlay.active {
          display: block;
        }
      }

      /* Overlay for mobile sidebar */
      .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 150;
        display: none;
      }

      @media (max-width: 768px) {
        .sidebar-overlay.active {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- Welcome Modal -->
    <div id="welcomeModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-logo">ü§ñ</div>
        <h2 class="modal-title">Bem-vindo ao CodeBot!</h2>
        <p class="modal-description">
          Sou o teu assistente de IA especializado em Code Start 2.0. Estou aqui
          para te ajudar com <strong>L√≥gica de Programa√ß√£o</strong>,
          <strong>Desenvolvimento Web + IA</strong> e
          <strong>Design Gr√°fico + Motion</strong>.
        </p>
        <button class="modal-btn" onclick="closeWelcomeModal()">
          Vamos come√ßar! üöÄ
        </button>
      </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div
      class="sidebar-overlay"
      id="sidebarOverlay"
      onclick="toggleSidebar()"
    ></div>

    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">ü§ñ</div>
          <div class="app-title">
            <a href="https://codestart20.vercel.app" style="color: #b3e234; text-decoration: none;">CodeBot</a>
          </div>
          <div class="app-subtitle">Code Start 2.0 AI Assistant</div>
        </div>

        <button class="new-chat-btn" onclick="startNewChat()">
          <span>‚ûï</span>
          Nova Conversa
        </button>

        <div class="chat-list" id="chatList">
          <!-- Chat history will be loaded here -->
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="header">
          <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
          <h1 class="header-title">CodeBot AI</h1>
          <div class="status">
            <div class="status-dot"></div>
            Online
          </div>
        </div>

        <div class="chat-area" id="chatArea">
          <!-- Welcome Screen -->
          <div class="welcome-screen" id="welcomeScreen">
            <h2 class="welcome-title">Ol√°! Como posso ajudar-te hoje?</h2>
            <p class="welcome-subtitle">
              Sou especializado nas √°reas do Code Start 2.0. Escolhe um t√≥pico
              abaixo ou faz a tua pergunta diretamente.
            </p>

            <div class="suggestions-grid">
              <div
                class="suggestion-card"
                onclick="sendSuggestion('Como posso come√ßar a aprender l√≥gica de programa√ß√£o do zero?')"
              >
                <span class="suggestion-icon">üß†</span>
                <h4 class="suggestion-title">L√≥gica de Programa√ß√£o</h4>
                <p class="suggestion-description">
                  Como posso come√ßar a aprender l√≥gica de programa√ß√£o do zero?
                </p>
              </div>

              <div
                class="suggestion-card"
                onclick="sendSuggestion('Quais as melhores tecnologias para desenvolvimento web com IA em 2024?')"
              >
                <span class="suggestion-icon">üåê</span>
                <h4 class="suggestion-title">Dev Web + IA</h4>
                <p class="suggestion-description">
                  Quais as melhores tecnologias para desenvolvimento web com IA
                  em 2024?
                </p>
              </div>

              <div
                class="suggestion-card"
                onclick="sendSuggestion('Como criar designs gr√°ficos profissionais e anima√ß√µes impactantes?')"
              >
                <span class="suggestion-icon">üé®</span>
                <h4 class="suggestion-title">Design Gr√°fico + Motion</h4>
                <p class="suggestion-description">
                  Como criar designs gr√°ficos profissionais e anima√ß√µes
                  impactantes?
                </p>
              </div>
            </div>
          </div>

          <!-- Typing Indicator -->
          <div class="typing-indicator" id="typingIndicator">
            <div class="typing-bubble">
              <span class="typing-text">CodeBot est√° a responder</span>
              <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-container">
            <div class="input-wrapper">
              <textarea
                id="messageInput"
                class="message-input"
                placeholder="Pergunta sobre L√≥gica de Programa√ß√£o, Dev Web + IA, ou Design Gr√°fico + Motion..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
              ></textarea>
            </div>
            <button
              id="sendBtn"
              class="send-btn"
              onclick="sendMessage()"
              title="Enviar mensagem"
            >
              ‚û§
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      class CodeBotAssistant {
        constructor() {
          // CONFIGURA AQUI A TUA API KEY DO GEMINI
          this.webhookUrl = "https://7d26b666c462.ngrok-free.app/webhook/codebot";

          this.currentChatId = null;
          this.chats = this.loadChats();
          this.sidebarVisible = true;

          this.init();
        }

        init() {
          this.loadChatHistory();
          this.checkFirstVisit();
          this.setupEventListeners();

          // Focus input
          document.getElementById("messageInput").focus();
        }

        checkFirstVisit() {
          const hasVisited = localStorage.getItem("codebotHasVisited");
          if (!hasVisited) {
            document.getElementById("welcomeModal").style.display = "flex";
            localStorage.setItem("codebotHasVisited", "true");
          }
        }

        setupEventListeners() {
          // Auto-resize textarea
          const input = document.getElementById("messageInput");
          input.addEventListener("input", () => this.autoResize(input));

          // Handle window resize
          window.addEventListener("resize", () => this.handleResize());
        }

        // Chat Management
        loadChats() {
          const saved = localStorage.getItem("codebotChats");
          return saved ? JSON.parse(saved) : {};
        }

        saveChats() {
          localStorage.setItem("codebotChats", JSON.stringify(this.chats));
        }

        generateChatId() {
          return (
            "chat_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9)
          );
        }

        startNewChat() {
          this.currentChatId = this.generateChatId();
          this.chats[this.currentChatId] = {
            title: "Nova Conversa",
            messages: [],
            timestamp: Date.now(),
          };
          this.saveChats();
          this.loadChatHistory();
          this.clearChatArea();
          this.showWelcomeScreen();

          // Focus input
          document.getElementById("messageInput").focus();
        }

        loadChat(chatId) {
          this.currentChatId = chatId;
          this.clearChatArea();

          const chat = this.chats[chatId];
          if (chat && chat.messages.length > 0) {
            chat.messages.forEach((msg) => {
              this.displayMessage(msg.content, msg.role);
            });
          } else {
            this.showWelcomeScreen();
          }

          this.updateActiveChatItem();
          this.scrollToBottom();
        }

        updateChatTitle(chatId, firstMessage) {
          if (this.chats[chatId]) {
            const title =
              firstMessage.length > 50
                ? firstMessage.substring(0, 50) + "..."
                : firstMessage;
            this.chats[chatId].title = title;
            this.saveChats();
            this.loadChatHistory();
          }
        }

        loadChatHistory() {
          const chatList = document.getElementById("chatList");
          chatList.innerHTML = "";

          const sortedChats = Object.entries(this.chats).sort(
            ([, a], [, b]) => b.timestamp - a.timestamp
          );

          sortedChats.forEach(([chatId, chat]) => {
            const chatItem = document.createElement("div");
            chatItem.className = "chat-item";
            if (chatId === this.currentChatId) {
              chatItem.classList.add("active");
            }

            chatItem.onclick = () => this.loadChat(chatId);

            const timeStr = new Date(chat.timestamp).toLocaleDateString(
              "pt-PT",
              {
                day: "2-digit",
                month: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
              }
            );

            chatItem.innerHTML = `
                        <div class="chat-title">${chat.title}</div>
                        <div class="chat-time">${timeStr}</div>
                    `;

            chatList.appendChild(chatItem);
          });
        }

        updateActiveChatItem() {
          document.querySelectorAll(".chat-item").forEach((item) => {
            item.classList.remove("active");
          });

          const chatItems = Array.from(document.querySelectorAll(".chat-item"));
          const sortedChatIds = Object.entries(this.chats)
            .sort(([, a], [, b]) => b.timestamp - a.timestamp)
            .map(([id]) => id);

          const activeIndex = sortedChatIds.indexOf(this.currentChatId);
          if (activeIndex !== -1 && chatItems[activeIndex]) {
            chatItems[activeIndex].classList.add("active");
          }
        }

        // Message Handling
        async sendMessage(content = null) {
          const input = document.getElementById("messageInput");
          const sendBtn = document.getElementById("sendBtn");

          const message = content || input.value.trim();
          if (!message) return;

          // Clear input and disable send button
          input.value = "";
          this.autoResize(input);
          sendBtn.disabled = true;

          // Hide welcome screen
          this.hideWelcomeScreen();

          // Create new chat if needed
          if (!this.currentChatId) {
            this.startNewChat();
          }

          // Display user message
          this.displayMessage(message, "user");
          this.addMessageToChat(message, "user");

          // Update chat title if first message
          if (this.chats[this.currentChatId].messages.length === 1) {
            this.updateChatTitle(this.currentChatId, message);
          }

          // Show typing indicator
          this.showTypingIndicator();

          try {
            // Get AI response
            const response = await this.getGeminiResponse(message);

            // Hide typing indicator and show response
            this.hideTypingIndicator();
            this.displayMessage(response, "assistant");
            this.addMessageToChat(response, "assistant");
          } catch (error) {
            console.error("Error:", error);
            this.hideTypingIndicator();

            let errorMessage = "üòî Desculpa, ocorreu um erro. ";
            if (error.message.includes("API key")) {
              errorMessage +=
                "Verifica se a tua API key do Gemini est√° correta.";
            } else if (
              error.message.includes("quota") ||
              error.message.includes("limit")
            ) {
              errorMessage +=
                "Limite de API atingido. Tenta novamente mais tarde.";
            } else {
              errorMessage += "Tenta novamente em alguns momentos.";
            }

            this.displayMessage(errorMessage, "assistant");
            this.addMessageToChat(errorMessage, "assistant");
          }

          sendBtn.disabled = false;
          document.getElementById("messageInput").focus();
          this.saveChats();
        }

        async getGeminiResponse(message) {
          const webhookUrl = "https://7d26b666c462.ngrok-free.app/webhook/codebot";

          const requestBody = {
            message: message,
            chatId: this.currentChatId,
            timestamp: Date.now(),
          };

          try {
            console.log(
              "üîÑ ENVIANDO PARA N8N:",
              JSON.stringify(requestBody, null, 2)
            );

            const response = await fetch(webhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestBody),
            });

            console.log("üìä STATUS:", response.status, response.statusText);

            if (!response.ok) {
              throw new Error(
                `Erro HTTP: ${response.status} ${response.statusText}`
              );
            }

            let data;
            try {
              data = await response.json();
              console.log("‚úÖ JSON RECEBIDO:", data);

              // Se for array com output
              if (Array.isArray(data) && data.length > 0 && data[0].output) {
                return data[0].output;
              }

              // Procura campos poss√≠veis de resposta
              const possibleFields = [
                "response",
                "chatOutput",
                "output",
                "text",
                "message",
                "data",
              ];
              for (const field of possibleFields) {
                if (data[field]) return data[field];
              }

              // Se n√£o encontrou campo conhecido, devolve JSON como string limpa
              return JSON.stringify(data);
            } catch {
              // Se n√£o for JSON, l√™ como texto puro
              const textData = await response.text();
              console.log("üìÑ TEXTO PURO RECEBIDO:", textData);
              if (!textData || textData.trim() === "")
                return "ERRO: n8n devolveu vazio";
              return textData;
            }
          } catch (error) {
            console.error("üí• ERRO AO CHAMAR N8N:", error);
            return `ERRO: ${error.message}`;
          }
        }

        addMessageToChat(content, role) {
          if (!this.currentChatId || !this.chats[this.currentChatId]) return;

          this.chats[this.currentChatId].messages.push({
            content,
            role,
            timestamp: Date.now(),
          });
        }

        displayMessage(content, role) {
          const chatArea = document.getElementById("chatArea");

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${role}`;

          const bubble = document.createElement("div");
          bubble.className = "message-bubble";

          const messageContent = document.createElement("div");
          messageContent.className = "message-content";
          messageContent.innerHTML = this.formatMessage(content);

          bubble.appendChild(messageContent);
          messageDiv.appendChild(bubble);
          chatArea.appendChild(messageDiv);

          this.scrollToBottom();
        }

        formatMessage(content) {
          // Escape HTML
          const div = document.createElement("div");
          div.textContent = content;
          let escaped = div.innerHTML;

          // Aplica formata√ß√µes b√°sicas de Markdown
          return escaped
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/`(.*?)`/g, "<code>$1</code>")
            .replace(/^### (.*$)/gm, "<h4>$1</h4>")
            .replace(/^## (.*$)/gm, "<h3>$1</h3>")
            .replace(/^\d+\.\s/gm, "<br>") // corrigido: n√£o mais texto indesejado
            .replace(/^[-‚Ä¢]\s/gm, "<br>‚Ä¢ ")
            .replace(/\n\n/g, "</p><p>")
            .replace(/\n/g, "<br>")
            .replace(/^(.)/gm, "<p>$1")
            .replace(/(.*)$/gm, "$1</p>")
            .replace(/<p><\/p>/g, "")
            .replace(/<p>(<h[3-4]>)/g, "$1")
            .replace(/(<\/h[3-4]>)<\/p>/g, "$1");
        }

        // UI Controls
        showWelcomeScreen() {
          document.getElementById("welcomeScreen").style.display = "block";
        }

        hideWelcomeScreen() {
          document.getElementById("welcomeScreen").style.display = "none";
        }

        clearChatArea() {
          const chatArea = document.getElementById("chatArea");
          chatArea.innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen" style="display: none;">
                        <h2 class="welcome-title">Ol√°! Como posso ajudar-te hoje?</h2>
                        <p class="welcome-subtitle">
                            Sou especializado nas √°reas do Code Start 2.0. Escolhe um t√≥pico abaixo ou faz a tua pergunta diretamente.
                        </p>
                        
                        <div class="suggestions-grid">
                            <div class="suggestion-card" onclick="sendSuggestion('Como posso come√ßar a aprender l√≥gica de programa√ß√£o do zero?')">
                                <span class="suggestion-icon">üß†</span>
                                <h4 class="suggestion-title">L√≥gica de Programa√ß√£o</h4>
                                <p class="suggestion-description">Como posso come√ßar a aprender l√≥gica de programa√ß√£o do zero?</p>
                            </div>
                            
                            <div class="suggestion-card" onclick="sendSuggestion('Quais as melhores tecnologias para desenvolvimento web com IA em 2024?')">
                                <span class="suggestion-icon">üåê</span>
                                <h4 class="suggestion-title">Dev Web + IA</h4>
                                <p class="suggestion-description">Quais as melhores tecnologias para desenvolvimento web com IA em 2024?</p>
                            </div>
                            
                            <div class="suggestion-card" onclick="sendSuggestion('Como criar designs gr√°ficos profissionais e anima√ß√µes impactantes?')">
                                <span class="suggestion-icon">üé®</span>
                                <h4 class="suggestion-title">Design Gr√°fico + Motion</h4>
                                <p class="suggestion-description">Como criar designs gr√°ficos profissionais e anima√ß√µes impactantes?</p>
                            </div>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-bubble">
                            <span class="typing-text">CodeBot est√° a responder</span>
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                `;
        }

        showTypingIndicator() {
          document.getElementById("typingIndicator").style.display = "flex";
          this.scrollToBottom();
        }

        hideTypingIndicator() {
          document.getElementById("typingIndicator").style.display = "none";
        }

        scrollToBottom() {
          const chatArea = document.getElementById("chatArea");
          chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Sidebar Controls
        toggleSidebar() {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");

          if (window.innerWidth <= 768) {
            // Mobile: toggle visibility
            sidebar.classList.toggle("visible");
            overlay.classList.toggle("active");
          } else {
            // Desktop: toggle hidden
            sidebar.classList.toggle("hidden");
          }
        }
        handleResize() {
          const sidebar = document.getElementById("sidebar");
          const overlay = document.getElementById("sidebarOverlay");

          if (window.innerWidth > 768) {
            // Desktop: remove mobile classes
            sidebar.classList.remove("visible");
            overlay.classList.remove("active");
          } else {
            // Mobile: ensure sidebar is hidden by default
            if (!sidebar.classList.contains("visible")) {
              overlay.classList.remove("active");
            }
          }
        }

        // Utility Methods
        autoResize(textarea) {
          textarea.style.height = "auto";
          textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
        }

        sendSuggestion(suggestion) {
          this.sendMessage(suggestion);
        }
      }

      // Global Functions
      let codeBot;

      function closeWelcomeModal() {
        document.getElementById("welcomeModal").style.display = "none";
        document.getElementById("messageInput").focus();
      }

      function toggleSidebar() {
        codeBot.toggleSidebar();
      }

      function startNewChat() {
        codeBot.startNewChat();
      }

      function sendMessage() {
        codeBot.sendMessage();
      }

      function sendSuggestion(suggestion) {
        codeBot.sendSuggestion(suggestion);
      }

      function handleKeyDown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      function autoResize(textarea) {
        codeBot.autoResize(textarea);
      }

      // Initialize App
      document.addEventListener("DOMContentLoaded", function () {
        codeBot = new CodeBotAssistant();
      });
    </script>
  </body>
</html>
